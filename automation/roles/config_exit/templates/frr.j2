{% set device = hostvars[inventory_hostname] %}
frr defaults datacenter
hostname {{ device.name|lower }}
username cumulus nopassword
!
service integrated-vtysh-config
!
log syslog informational
!
{% for vxlan_interface in device.vxlan.interfaces %}
{% set vxlan_interface_vars = device.vxlan.interfaces[vxlan_interface] %}
{% if vxlan_interface_vars.vni_type|lower == "l3"%}
vrf {{ vxlan_interface_vars.vrf }}
  vni {{ vxlan_interface_vars.vxlan_id }}
exit-vrf
{% endif %}
{% endfor %}
!
!



router bgp {{ device.asn }}
 bgp router-id {{ device.lo.ipv4 }}
 bgp bestpath as-path multipath-relax
 neighbor fabric peer-group
 neighbor fabric remote-as external
 neighbor fabric bfd
{% for interface in device.interfaces %}
{% set interface_vars = device.interfaces[interface] %}
{% if interface_vars.port_type|lower == "uplink" %}
 neighbor {{ interface }} interface peer-group fabric
{% endif %}
{% endfor %}
 !
 address-family ipv4 unicast
  network {{ device.lo.ipv4 }}/32
 exit-address-family
 !
 address-family l2vpn evpn
  neighbor fabric activate
  advertise-all-vni
 exit-address-family
!


{% for vrf in device.routing.bgp.vrf %}
router bgp {{ device.asn }} vrf {{ vrf }}
 bgp router-id {{ device.lo.ipv4 }}
 no bgp default ipv4-unicast
{% set vrf_vars = device.routing.bgp.vrf[vrf] %}
{% for neighbor in vrf_vars %}
{% set neighbor_vars = vrf_vars[neighbor] %}
{% if neighbor_vars.ipv4_address is defined %}
 neighbor {{ neighbor_vars.ipv4_address }} remote-as {{ neighbor_vars.asn }}
{% endif %}
{% if neighbor_vars.ipv6_address is defined %}
 neighbor {{ neighbor_vars.ipv6_address }} remote-as {{ neighbor_vars.asn }}
{% endif %}
 !
 address-family ipv4 unicast
{% if neighbor_vars.ipv4_address is defined %}
  neighbor {{ neighbor_vars.ipv4_address }} activate
  neighbor {{ neighbor_vars.ipv4_address }} soft-reconfiguration inbound
{% endif %}
 exit-address-family
 !
 address-family ipv6 unicast
{% if neighbor_vars.ipv6_address is defined %}
  neighbor {{ neighbor_vars.ipv6_address }} activate
  neighbor {{ neighbor_vars.ipv6_address }} soft-reconfiguration inbound
{% endif %}
 exit-address-family
 !
  address-family l2vpn evpn
    advertise ipv4 unicast
    advertise ipv6 unicast
  exit-address-family
 !
{% endfor %}
{% endfor %}
 !
line vty
